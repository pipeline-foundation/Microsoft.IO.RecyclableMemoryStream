name: CI/CD Pipeline

on:
  push:
    paths:
      - 'src/**'
      - 'UnitTests/**'
  pull_request:
    paths:
      - 'src/**'
      - 'UnitTests/**'
  workflow_dispatch:

jobs:
  ci:
    name: Continuous Integration
    runs-on: ubuntu-latest
    outputs:
      latest_version: ${{ steps.tag_generator.outputs.new_version }}
    steps:
      - name: Data gatherer
        id: data_gatherer
        shell: pwsh
        run: |
          # Get default branch
          $repo = "${{ github.repository }}"
          $defaultBranch = Invoke-RestMethod -Method GET -Uri https://api.github.com/repos/$repo | Select-Object -ExpandProperty default_branch

          Write-Output "::set-output name=default_branch::$(echo $defaultBranch)"
          
      - name: Conditionals handler
        id: conditionals_handler
        shell: pwsh
        run: |
          $defaultBranch = "${{ steps.data_gatherer.outputs.default_branch }}"
          $githubRef = "${{ github.ref }}"
          $currentBranch = $githubRef -replace 'refs/heads/', ''
          $githubEventName = "${{ github.event_name }}"
          $isDefaultBranch = 'false'
          $isPush = 'false'
          $isPushToDefaultBranch = 'false'

          if ( $currentBranch -eq $defaultBranch ) {
            $isDefaultBranch = 'true'
          }
          if ( $githubEventName -eq 'push' ) {
            $isPush = 'true'
          }
          if ( $currentBranch -eq $defaultBranch -and $githubEventName -eq 'push' ) {
            $isPushToDefaultBranch = 'true'
          }

          Write-Output "::set-output name=is_default_branch::$(echo $isDefaultBranch)"
          Write-Output "::set-output name=is_push::$(echo $isPush)"
          Write-Output "::set-output name=is_push_to_default_branch::$(echo $isPushToDefaultBranch)"

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v1
        with:
          dotnet-version: 5.0.203

      - name: Checkout repository
        uses: actions/checkout@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - if: steps.conditionals_handler.outputs.is_push_to_default_branch == 'true'
        name: Bump GH tag
        id: tag_generator
        uses: mathieudutour/github-tag-action@v5.4
        with: 
          github_token: ${{ secrets.GITHUB_TOKEN }}
          default_bump: false
          release_branches: ${{ steps.data_gatherer.outputs.default_branch }}
          tag_prefix: ''

      - name: Restore solution
        shell: pwsh
        run: |
          dotnet restore Microsoft.IO.RecyclableMemoryStream.sln

      - name: Build solution
        shell: pwsh
        run: |
          dotnet build Microsoft.IO.RecyclableMemoryStream.sln `
          --configuration Release `
          --no-restore

      - name: Run unit tests
        shell: pwsh
        run: |
          $projectName = "${{ github.event.repository.name }}"
          $date = Get-Date -Format "MM-dd-yyyy"

          dotnet test Microsoft.IO.RecyclableMemoryStream.sln `
          --configuration Release `
          --logger "trx;LogFileName=$projectName-$date.trx;verbosity=normal" `
          --results-directory 'Test results/' `
          --no-build

      - name: Upload test results as pipeline artifact
        uses: actions/upload-artifact@v2
        with:
          name: Test results
          path: 'Test results/'

      - name: Version determiner
        id: version_determiner
        shell: pwsh
        run: |
          $gitNewVersion = if ("${{ steps.tag_generator.outputs.new_version }}") {"${{ steps.tag_generator.outputs.new_version }}"} else {$null}
          $projectFilePath = 'src/Microsoft.IO.RecyclableMemoryStream.csproj'
          $projectCurrentVersion = [String](([xml](Get-Content -Path $projectFilePath)).Project.PropertyGroup.PackageVersion) -replace '\s', ''
          $projectNewVersion = $gitNewVersion ?? $projectCurrentVersion

          Write-Output "::set-output name=project_version::$(echo $projectNewVersion)"

      - name: Publish project for each target framework
        shell: pwsh
        run: |
          $projectVersion = "${{ steps.version_determiner.outputs.project_version }}"
          $projectFilePath = 'src/Microsoft.IO.RecyclableMemoryStream.csproj'
          $targetFrameworksProperty = [String](([xml](Get-Content -Path $projectFilePath)).Project.PropertyGroup.TargetFrameworks)
          $targetFrameworks = $targetFrameworksProperty.split(';')

          foreach ( $framework in $targetFrameworks ) {
            $frameworkNum = [String]($framework -replace ' ', '')

            dotnet publish $projectFilePath `
            --configuration Release `
            --output "Publish outputs/$frameworkNum" `
            --framework $frameworkNum `
            -property:PackageVersion=$projectVersion `
            --no-restore
          }

      - name: Upload publish output as pipeline artifact
        uses: actions/upload-artifact@v2
        with:
          name: Publish outputs
          path: 'Publish outputs/'

      - name: Pack solution
        shell: pwsh
        run: |
          $projectVersion = "${{ steps.version_determiner.outputs.project_version }}"

          dotnet pack Microsoft.IO.RecyclableMemoryStream.sln `
          --configuration Release `
          --output NuGet `
          -property:PackageVersion=$projectVersion `
          --no-restore

      - name: Upload NuGet packages as pipeline artifact
        uses: actions/upload-artifact@v2
        with:
          name: NuGet packages
          path: NuGet/

      - if: steps.tag_generator.outputs.new_version != ''
        name: Update version in project
        shell: pwsh
        run: |
          $projFilePath = 'src/Microsoft.IO.RecyclableMemoryStream.csproj'
          $projContent = Get-Content -Path $projFilePath -Raw
          $updatedProjContent = $projContent -replace '<PackageVersion>.*</PackageVersion>', "<PackageVersion>${{ steps.tag_generator.outputs.new_version }}</PackageVersion>"

          $updatedProjContent | Set-Content -Path $projFilePath

          $userEmail = "ci-cd-pipeline@my.workflow"
          $userName = "ci-cd-pipeline"
          $commitMessage = "update project version to ${{ steps.tag_generator.outputs.new_version }}"
          
          git config --global user.email $userEmail
          git config --global user.name $userName
          git add $projFilePath
          git commit -m $commitMessage
          git push origin "${{ steps.data_gatherer.outputs.default_branch }}"

  cd:
    if: needs.ci.outputs.latest_version != ''
    name: Continuous Deployment
    needs: ci
    runs-on: ubuntu-latest
    steps:
      # GH CLI requires a cloned repo
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Download and extract NuGet packages artifact
        uses: actions/download-artifact@v2
        with:
          name: NuGet packages
          path: NuGet/

      - name: Push NuGet packages to NuGet.org
        continue-on-error: true
        shell: pwsh
        run: |
          nuget push NuGet/Microsoft.IO.RecyclableMemoryStream.${{ needs.ci.outputs.latest_version }}.nupkg `
          -ApiKey $env:NUGET_API_KEY `
          -Source https://api.nuget.org/v3/index.json
        env:
          NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}

      - name: Create and publish release
        shell: pwsh
        run: |
          $releaseTag = "${{ needs.ci.outputs.latest_version }}"
          $releaseTitle = "Microsoft.IO.RecyclableMemoryStream ${{ needs.ci.outputs.latest_version }}"
          $releaseAssets = "NuGet/Microsoft.IO.RecyclableMemoryStream.${{ needs.ci.outputs.latest_version }}.nupkg"

          gh release create $releaseTag -t $releaseTitle $releaseAssets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

# Built with ‚ù§ by [Pipeline Foundation](https://pipeline.foundation)
